# 订阅升级功能测试

## 功能概述
已修复订阅升级逻辑问题，现在支持按差价升级，而不是全款购买。

## 主要改进

### 1. 后端改进
- **新增升级服务方法**：`upgradeSubscription()` - 处理订阅升级逻辑
- **新增差价计算方法**：`calculateUpgradePrice()` - 计算升级差价
- **新增升级接口**：
  - `POST /api/subscription/upgrade` - 执行升级
  - `GET /api/subscription/upgrade/price` - 计算差价

### 2. 前端改进
- **升级对话框优化**：显示原价、升级差价和剩余天数
- **智能支付逻辑**：自动判断是升级还是新建订阅
- **实时差价计算**：打开升级对话框时自动计算差价

## 升级逻辑

### 差价计算公式
```
升级差价 = (新套餐日价格 - 当前套餐日价格) × 剩余天数
```

### 示例计算
- 基础套餐：¥7/月 = ¥0.23/天
- 专业套餐：¥17/月 = ¥0.57/天
- 剩余15天：差价 = (0.57 - 0.23) × 15 = ¥5.1

## 测试场景

### 场景1：基础会员升级到专业会员
1. 用户当前为基础会员（¥7/月）
2. 剩余20天
3. 升级到专业会员（¥17/月）
4. 预期差价：¥6.67

### 场景2：专业会员升级到企业会员
1. 用户当前为专业会员（¥17/月）
2. 剩余10天
3. 升级到企业会员（¥49/月）
4. 预期差价：¥10.67

### 场景3：免费用户升级
1. 用户当前为免费用户
2. 升级到任意付费套餐
3. 按全价收费（无差价）

## 验证步骤

1. **启动后端服务**
2. **访问订阅页面**
3. **点击升级按钮**
4. **查看差价计算是否正确**
5. **执行升级操作**
6. **验证订阅状态更新**

## 注意事项

- 升级后原订阅会被标记为CANCELLED
- 新订阅的结束日期与原订阅相同
- 升级差价不能为负数
- 不支持降级操作
